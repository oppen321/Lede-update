#!/bin/ash

# 显示菜单
show_menu() {
    echo "=============================="
    echo "  ZeroWrt 选项菜单"
    echo "=============================="
    echo "1. 更换 LAN 口 IP 地址"
    echo "2. 更改管理员密码"
    echo "3. 切换默认主题"
    echo "4. 一键重置配置"
    echo "5. 网络向导"
    echo "6. 开关 IPv6 功能"
    echo "0. 退出"
    echo "=============================="
    printf "请输入您的选择 [0-6]: "
    read choice
    case "$choice" in
        1) change_ip ;;
        2) change_password ;;
        3) change_theme ;;
        4) reset_config ;;
        5) network_wizard ;;
        6) toggle_ipv6 ;;
        0) exit 0 ;;
        *) echo "无效选项，请重新输入"; show_menu ;;
    esac
}

# 1. 更换 LAN 口 IP 地址
change_ip() {
    printf "请输入新的 LAN 口 IP 地址（如 192.168.1.2）："
    read new_ip
    if [ -n "$new_ip" ]; then
        uci set network.lan.ipaddr="$new_ip"
        uci commit network
        /etc/init.d/network restart
        echo "LAN 口 IP 已成功更改为 $new_ip"
    else
        echo "未输入有效的 IP 地址，操作取消。"
    fi
    printf "按 Enter 键返回菜单..."
    read
    show_menu
}

# 2. 更改管理员密码
change_password() {
    printf "请输入新密码："
    read new_password
    if [ -n "$new_password" ]; then
        echo -e "$new_password\n$new_password" | passwd root
        echo "管理员密码已成功更改。"
    else
        echo "未输入有效密码，操作取消。"
    fi
    printf "按 Enter 键返回菜单..."
    read
    show_menu
}

# 3. 切换默认主题
change_theme() {
    uci set luci.main.mediaurlbase='/luci-static/bootstrap'
    uci commit luci
    echo "主题已切换为默认的 OpenWrt 主题（luci-theme-bootstrap）。"
    printf "按 Enter 键返回菜单..."
    read
    show_menu
}

# 4. 一键重置配置
reset_config() {
    echo "正在恢复出厂设置..."
    firstboot -y
    echo "设备将在 5 秒后重启..."
    sleep 5
    reboot
}

# 5. 网络向导
network_wizard() {
    echo "=============================="
    echo "  网络向导"
    echo "=============================="
    echo "1. DHCP 模式"
    echo "2. PPPoE 模式"
    echo "3. 旁路由模式"
    echo "0. 返回上一级菜单"
    echo "=============================="
    printf "请输入您的选择 [0-3]: "
    read net_choice
    case "$net_choice" in
        1) set_dhcp_mode ;;
        2) set_pppoe_mode ;;
        3) set_bypass_mode ;;
        0) show_menu ;;
        *) echo "无效选项，请重新输入"; network_wizard ;;
    esac
}

# 设置 DHCP 模式
set_dhcp_mode() {
    echo "正在设置为 DHCP 模式..."
    uci set network.wan.proto='dhcp'
    uci commit network
    enable_full_nat
    enable_syn_flood
    enable_lan_dhcp
    disable_lan_masquerade
    /etc/init.d/network restart
    echo "已设置为 DHCP 模式。"
    printf "按 Enter 键返回菜单..."
    read
    network_wizard
}

# 设置 PPPoE 模式
set_pppoe_mode() {
    printf "请输入 PPPoE 用户名："
    read username
    printf "请输入 PPPoE 密码："
    read password
    if [ -n "$username" ] && [ -n "$password" ]; then
        uci set network.wan.proto='pppoe'
        uci set network.wan.username="$username"
        uci set network.wan.password="$password"
        uci commit network
        enable_full_nat
        enable_syn_flood
        enable_lan_dhcp
        disable_lan_masquerade
        /etc/init.d/network restart
        echo "PPPoE 模式已设置完成。"
    else
        echo "未输入有效的用户名或密码，操作取消。"
    fi
    printf "按 Enter 键返回菜单..."
    read
    network_wizard
}

# 设置旁路由模式
set_bypass_mode() {
    printf "请输入 LAN 口 IP 地址（默认 192.168.2.1）："
    read lan_ip
    [ -z "$lan_ip" ] && lan_ip="192.168.2.1"

    printf "请输入网关地址（默认 192.168.1.1）："
    read gateway
    [ -z "$gateway" ] && gateway="192.168.1.1"

    printf "请输入 DNS 地址（默认 223.5.5.5）："
    read dns
    [ -z "$dns" ] && dns="223.5.5.5"

    echo "正在设置为旁路由模式..."
    uci set network.lan.ipaddr="$lan_ip"
    uci set network.lan.gateway="$gateway"
    uci set network.lan.dns="$dns"
    uci set network.lan.delegate='0'
    uci delete network.lan.ip6assign
    uci commit network

    uci set dhcp.lan.ignore='1'
    uci set dhcp.lan.dhcpv6='disabled'
    uci set dhcp.lan.ra='disabled'
    uci set dhcp.lan.ndp='disabled'
    uci commit dhcp

    uci set firewall.@zone[0].masq='1'
    uci set firewall.@zone[0].mtu_fix='1'
    uci set firewall.@zone[1].masq='1'
    uci set firewall.@zone[1].mtu_fix='1'
    uci commit firewall

    disable_full_nat
    disable_syn_flood
    /etc/init.d/network restart
    /etc/init.d/firewall restart

    echo "旁路由模式已设置："
    echo "LAN IP: $lan_ip"
    echo "网关: $gateway"
    echo "DNS: $dns"
    printf "按 Enter 键返回菜单..."
    read
    network_wizard
}

# 禁用 LAN 区域动态伪装
disable_lan_masquerade() {
    uci set firewall.@zone[0].masq='0'
    uci set firewall.@zone[0].mtu_fix='0'
    uci commit firewall
}

# 启用 FullCone-NAT
enable_full_nat() {
    uci set firewall.@defaults[0].fullcone='1'
    uci commit firewall
}

# 禁用 FullCone-NAT
disable_full_nat() {
    uci set firewall.@defaults[0].fullcone='0'
    uci commit firewall
}

# 启用 SYN-flood 防御
enable_syn_flood() {
    uci set firewall.@defaults[0].synflood_protect='1'
    uci commit firewall
}

# 禁用 SYN-flood 防御
disable_syn_flood() {
    uci set firewall.@defaults[0].synflood_protect='0'
    uci commit firewall
}

# 启用 LAN 口 DHCP 服务
enable_lan_dhcp() {
    uci delete dhcp.lan.ignore
    uci set dhcp.lan.start='100'
    uci set dhcp.lan.limit='150'
    uci set dhcp.lan.leasetime='12h'
    uci commit dhcp
}

# 主程序入口
while true; do
    show_menu
done
